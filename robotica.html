<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Controle de Presença - Clube de Robótica</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body { background-color: #f8f9fa; padding: 16px; }
  table th, table td { text-align: center; vertical-align: middle; }
  .btn { min-width: 140px; }
  .status-cell { font-size: .9rem; }
  .saved { background-color: #e9fbe9 !important; }
  .error { background-color: #fde9e9 !important; }
</style>
</head>
<body>
<div class="container">
  <h2 class="mb-3 text-center">Controle de Presença - Clube de Robótica</h2>

  <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
    <button class="btn btn-success" onclick="marcarTodos(true)">✅ Habilitar Todos</button>
    <button class="btn btn-danger" onclick="marcarTodos(false)">❌ Desabilitar Todos</button>
  </div>

  <div class="table-responsive">
    <table id="tabelaPresenca" class="table table-bordered table-striped table-hover align-middle">
      <thead class="table-dark">
        <tr>
          <th style="width: 80px;">Número</th>
          <th>Nome</th>
          <th style="min-width: 160px;">Data da Aula</th>
          <th style="width: 120px;">Presente</th>
          <th style="width: 130px;">% Presença</th>
          <th style="width: 120px;">Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- 50 nomes fictícios (substitua quando quiser) -->
        <tr><td>1</td><td>Ana Souza</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>2</td><td>Bruno Almeida</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>3</td><td>Carla Santos</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>4</td><td>Diego Pereira</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>5</td><td>Eduarda Martins</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>6</td><td>Felipe Carvalho</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>7</td><td>Gabriela Lima</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>8</td><td>Henrique Silva</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>9</td><td>Isabela Rocha</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>10</td><td>João Oliveira</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>

        <tr><td>11</td><td>Karina Barbosa</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>12</td><td>Lucas Ferreira</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>13</td><td>Mariana Duarte</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>14</td><td>Natália Gomes</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>15</td><td>Otávio Figueiredo</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>16</td><td>Patrícia Correia</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>17</td><td>Ricardo Monteiro</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>18</td><td>Sabrina Nogueira</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>19</td><td>Thiago Ribeiro</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>20</td><td>Vitória Campos</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>

        <tr><td>21</td><td>André Teixeira</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>22</td><td>Bárbara Pinto</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>23</td><td>César Melo</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>24</td><td>Diana Pires</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>25</td><td>Eduardo Matos</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>26</td><td>Fernanda Borges</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>27</td><td>Gustavo Freitas</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>28</td><td>Helena Cardoso</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>29</td><td>Igor Castro</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>30</td><td>Jéssica Lopes</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>

        <tr><td>31</td><td>Kevin Araújo</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>32</td><td>Lívia Rocha</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>33</td><td>Mateus Cunha</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>34</td><td>Nina Castro</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>35</td><td>Paulo Mendes</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>36</td><td>Queila Andrade</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>37</td><td>Rafael Moraes</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>38</td><td>Sofia Tavares</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>39</td><td>Tiago Fernandes</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>40</td><td>Ursula Prado</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>

        <tr><td>41</td><td>Vagner Reis</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>42</td><td>Wellington Moraes</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>43</td><td>Xavier Costa</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>44</td><td>Yara Barbosa</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>45</td><td>Zeca Brito</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>46</td><td>Alice Moura</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>47</td><td>Brenda Rocha</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>48</td><td>Claudio Neves</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>49</td><td>Daniela Vasconcelos</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
        <tr><td>50</td><td>Everton Souza</td><td><input type="date" class="form-control"></td><td><input type="checkbox" onchange="atualizarPercentual(this)"></td><td class="percentual">0%</td><td class="status-cell"></td></tr>
      </tbody>
    </table>
  </div>

  <div class="text-center mt-3">
    <button id="btnSalvar" class="btn btn-primary" onclick="salvarNoBaserow()">💾 Salvar no Baserow</button>
  </div>

  <div class="text-center mt-2">
    <small class="text-muted">Dica: preencha a data da aula antes de salvar. Linhas sem data serão ignoradas.</small>
  </div>
</div>

<script>
  // ===== CONFIG Baserow =====
  const API_TOKEN = "zaa0Pfbm4SCbaivRvMmlSEWGKdtldXNd";
  const TABLE_ID  = "642370";

  // IDs dos campos no Baserow (fornecidos por você)
  const FIELDS = {
    numero_aluno:   5247573,
    nome_aluno:     5247574,
    data_aula:      5247596,
    presente:       5247575,
    total_aulas:    5247608,
    aulas_presentes:5247609,
    percentual:     5247669
  };

  // Total de aulas (ajuste conforme sua realidade)
  const totalAulas = 10;

  function marcarTodos(status) {
    document.querySelectorAll('#tabelaPresenca tbody input[type="checkbox"]').forEach(cb => {
      cb.checked = status;
      atualizarPercentual(cb);
    });
  }

  function atualizarPercentual(checkbox) {
    const row = checkbox.closest('tr');
    const percentualCell = row.querySelector('.percentual');
    const aulasPresentes = checkbox.checked ? 1 : 0;
    const percentual = (aulasPresentes / totalAulas) * 100;
    percentualCell.textContent = percentual.toFixed(1) + '%';
  }

  function fieldKey(id) {
    // Baserow espera chaves no formato "field_ID"
    return `field_${id}`;
  }

  async function salvarNoBaserow() {
    const btn = document.getElementById('btnSalvar');
    btn.disabled = true;
    btn.textContent = "Salvando...";

    const linhas = document.querySelectorAll('#tabelaPresenca tbody tr');
    let enviados = 0, ignorados = 0, erros = 0;

    for (const row of linhas) {
      const numero = parseInt(row.cells[0].textContent.trim(), 10);
      const nome = row.cells[1].textContent.trim();
      const dataAula = row.querySelector('input[type="date"]').value;
      const presente = row.querySelector('input[type="checkbox"]').checked;

      // Ignora linhas sem data (não há aula a registrar)
      if (!dataAula) {
        ignorados++;
        marcarStatus(row, "Sem data", "secondary");
        continue;
      }

      const aulasPresentes = presente ? 1 : 0;
      const percentual = Number(((aulasPresentes / totalAulas) * 100).toFixed(1));

      const payload = {
        fields: {
          [fieldKey(FIELDS.numero_aluno)]: numero,
          [fieldKey(FIELDS.nome_aluno)]: nome,
          [fieldKey(FIELDS.data_aula)]: dataAula,    // YYYY-MM-DD
          [fieldKey(FIELDS.presente)]: presente,     // boolean
          [fieldKey(FIELDS.total_aulas)]: totalAulas,
          [fieldKey(FIELDS.aulas_presentes)]: aulasPresentes,
          [fieldKey(FIELDS.percentual)]: percentual
        }
      };

      try {
        const res = await fetch(`https://api.baserow.io/api/database/rows/table/${TABLE_ID}/`, {
          method: "POST",
          headers: {
            "Authorization": `Token ${API_TOKEN}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          erros++;
          const errText = await res.text();
          marcarStatus(row, "Erro", "danger", errText);
        } else {
          enviados++;
          marcarStatus(row, "Salvo", "success");
        }
      } catch (e) {
        erros++;
        marcarStatus(row, "Erro", "danger", e?.message || "Falha de rede");
      }
    }

    btn.disabled = false;
    btn.textContent = "💾 Salvar no Baserow";

    const msg = `Concluído: ${enviados} salvo(s), ${ignorados} ignorado(s) (sem data), ${erros} erro(s).`;
    alert(msg);
  }

  function marcarStatus(row, texto, tipo, tooltip) {
    const statusCell = row.querySelector('.status-cell');
    statusCell.innerHTML = `<span class="badge text-bg-${tipo}" ${tooltip ? `title="${escapeHtml(tooltip)}"` : ""}>${texto}</span>`;
    row.classList.remove('saved', 'error');
    if (tipo === 'success') row.classList.add('saved');
    if (tipo === 'danger') row.classList.add('error');
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
</script>
</body>
</html>
